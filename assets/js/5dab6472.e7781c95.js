"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[4402],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>m});var r=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var p=r.createContext({}),s=function(e){var t=r.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=s(e.components);return r.createElement(p.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},f=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,p=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),f=s(n),m=o,g=f["".concat(p,".").concat(m)]||f[m]||u[m]||a;return n?r.createElement(g,i(i({ref:t},c),{},{components:n})):r.createElement(g,i({ref:t},c))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,i=new Array(a);i[0]=f;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l.mdxType="string"==typeof e?e:o,i[1]=l;for(var s=2;s<a;s++)i[s]=n[s];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}f.displayName="MDXCreateElement"},5274:(e,t,n)=>{n.r(t),n.d(t,{frontMatter:()=>l,contentTitle:()=>p,metadata:()=>s,toc:()=>c,default:()=>f});var r=n(7462),o=n(3366),a=(n(7294),n(3905)),i=["components"],l={id:"pprof",title:"Tips for profiling CKB script"},p=void 0,s={unversionedId:"develop/pprof",id:"develop/pprof",title:"Tips for profiling CKB script",description:"Before starting, make sure you have understood the concept of cycles.",source:"@site/docs/develop/pprof.md",sourceDirName:"develop",slug:"/develop/pprof",permalink:"/docs-new_toolchain/docs/develop/pprof",tags:[],version:"current",frontMatter:{id:"pprof",title:"Tips for profiling CKB script"},sidebar:"Develop",previous:{title:"Tips for Debugging CKB Scripts",permalink:"/docs-new_toolchain/docs/develop/debug"},next:{title:"The General Workflow for Constructing a Transaction",permalink:"/docs-new_toolchain/docs/develop/rules"}},c=[{value:"Get ckb-vm-pprof",id:"get-ckb-vm-pprof",children:[],level:2},{value:"Basic usage",id:"basic-usage",children:[{value:"Build with -g option",id:"build-with--g-option",children:[],level:3},{value:"Install visualization package",id:"install-visualization-package",children:[],level:3},{value:"Get reports",id:"get-reports",children:[],level:3}],level:2}],u={toc:c};function f(e){var t=e.components,n=(0,o.Z)(e,i);return(0,a.kt)("wrapper",(0,r.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"Before starting, make sure you have understood the concept of ",(0,a.kt)("a",{parentName:"p",href:"basics/glossary#cycles"},"cycles"),"."),(0,a.kt)("p",null,"In the development phase of dapps, it is a wide range of needs to estimate how many cycles our dapp will consume."),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://github.com/nervosnetwork/ckb-vm-pprof"},"ckb-vm-pprof")," is a tool for visualization and analysis of profiling data. It can run a script off-chain and then collect the runtime data. According to your preference, It can generate both text and graphical reports."),(0,a.kt)("h2",{id:"get-ckb-vm-pprof"},"Get ckb-vm-pprof"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ git clone https://github.com/nervosnetwork/ckb-vm-pprof\n$ cd ckb-vm-pprof\n$ cargo build --release\n")),(0,a.kt)("p",null,"The executable file is located at ",(0,a.kt)("inlineCode",{parentName:"p"},"./target/release/ckb-vm-pprof"),", you can copy it to any ",(0,a.kt)("inlineCode",{parentName:"p"},"$PATH")," you like."),(0,a.kt)("h2",{id:"basic-usage"},"Basic usage"),(0,a.kt)("p",null,"Suppose the program to be tested is:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-c"},"int fib(int n) {\n    if (n == 0 || n == 1) {\n        return n;\n    } else {\n        return fib(n-1) + fib(n-2);\n    }\n}\n\nint main() {\n    if (fib(10) != 55) {\n        return 1;\n    }\n    return 0;\n}\n")),(0,a.kt)("p",null,"The Fibonacci function is used in the example because it is not only simple enough, but also a recursive function."),(0,a.kt)("h3",{id:"build-with--g-option"},"Build with -g option"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"-g")," option, described in the gcc documentation as:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"-g\nProduce debugging information in the operating system\u2019s native format (stabs, COFF, XCOFF, or DWARF). GDB can work with this debugging information.\n\nOn most systems that use stabs format, -g enables use of extra debugging information that only GDB can use; this extra information makes debugging work better in GDB but probably makes other debuggers crash or refuse to read the program. If you want to control for certain whether to generate the extra information, use -gstabs+, -gstabs, -gxcoff+, -gxcoff, or -gvms (see below).\n")),(0,a.kt)("p",null,"It is necessary to bring it when compiling, so the compilation command is:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"$ riscv64-unknown-elf-gcc -g -o fib fib.c\n")),(0,a.kt)("h3",{id:"install-visualization-package"},"Install visualization package"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"If you only need a text report, you can ignore this step.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"$ cargo install inferno\n")),(0,a.kt)("p",null,"Inferno is a port of parts of the flamegraph toolkit to Rust, with the aim of improving the performance of the original flamegraph tools."),(0,a.kt)("h3",{id:"get-reports"},"Get reports"),(0,a.kt)("p",null,"We just need to use ckb-vm-pprof to run the binary fib:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"$ ckb-vm-pprof --bin fib > flamegraph.txt\n\n$ cat flamegraph.txt\n??:?? 938\n??:??; /src/ckb-vm-pprof/res/fib.c:main 24\n??:??; /src/ckb-vm-pprof/res/fib.c:main; /src/ckb-vm-pprof/res/fib.c:fib 7311\n")),(0,a.kt)("p",null,"The basic format of the text report is ",(0,a.kt)("inlineCode",{parentName:"p"},"Function0; Function1; ... FunctionN Cycles"),", that is, the call stack and the final cycles. ",(0,a.kt)("inlineCode",{parentName:"p"},"??:??")," means that some codes that does not belong to any user defined function(usually generated by the compiler)."),(0,a.kt)("p",null,"Generate graphics for easy reading:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"$ cat flamegraph.txt | inferno-flamegraph > fib.svg\n")),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://raw.githubusercontent.com/nervosnetwork/ckb-vm-pprof/master/res/fib.svg",alt:"fib.svg"})),(0,a.kt)("p",null,"Please note that the function with too small proportion will not be displayed on the flamegraph by default."))}f.isMDXComponent=!0}}]);