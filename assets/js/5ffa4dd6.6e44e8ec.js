"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[9013],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>f});var l=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);t&&(l=l.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,l)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?c(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):c(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,l,a=function(e,t){if(null==e)return{};var n,l,a={},c=Object.keys(e);for(l=0;l<c.length;l++)n=c[l],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(e);for(l=0;l<c.length;l++)n=c[l],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var r=l.createContext({}),s=function(e){var t=l.useContext(r),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=s(e.components);return l.createElement(r.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return l.createElement(l.Fragment,{},t)}},d=l.forwardRef((function(e,t){var n=e.components,a=e.mdxType,c=e.originalType,r=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),d=s(n),f=a,m=d["".concat(r,".").concat(f)]||d[f]||p[f]||c;return n?l.createElement(m,o(o({ref:t},u),{},{components:n})):l.createElement(m,o({ref:t},u))}));function f(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var c=n.length,o=new Array(c);o[0]=d;var i={};for(var r in t)hasOwnProperty.call(t,r)&&(i[r]=t[r]);i.originalType=e,i.mdxType="string"==typeof e?e:a,o[1]=i;for(var s=2;s<c;s++)o[s]=n[s];return l.createElement.apply(null,o)}return l.createElement.apply(null,n)}d.displayName="MDXCreateElement"},7664:(e,t,n)=>{n.r(t),n.d(t,{frontMatter:()=>s,contentTitle:()=>u,metadata:()=>p,toc:()=>d,default:()=>m});var l=n(7462),a=n(3366),c=(n(7294),n(3905)),o=n(4996),i=n(9960),r=["components"],s={id:"querycapacity",title:"Query on CKB Capacity"},u=void 0,p={unversionedId:"develop/tools/lumos/guides/querycapacity",id:"develop/tools/lumos/guides/querycapacity",title:"Query on CKB Capacity",description:"Prerequisites",source:"@site/docs/develop/tools/lumos/guides/queryCapacity.md",sourceDirName:"develop/tools/lumos/guides",slug:"/develop/tools/lumos/guides/querycapacity",permalink:"/develop/docs/develop/tools/lumos/guides/querycapacity",tags:[],version:"current",frontMatter:{id:"querycapacity",title:"Query on CKB Capacity"},sidebar:"Develop",previous:{title:"Query on Cells",permalink:"/develop/docs/develop/tools/lumos/guides/querycells"},next:{title:"Query on Transactions",permalink:"/develop/docs/develop/tools/lumos/guides/querytransactions"}},d=[{value:"Prerequisites",id:"prerequisites",children:[],level:2},{value:"Environment",id:"environment",children:[],level:2},{value:"Examples",id:"examples",children:[{value:"Get Cell Minimal Capacity",id:"get-cell-minimal-capacity",children:[],level:3},{value:"Get the Balance of an Account",id:"get-the-balance-of-an-account",children:[],level:3},{value:"Get the SUDT Balance of an Account",id:"get-the-sudt-balance-of-an-account",children:[],level:3},{value:"Find Cells for Sufficient Capacity",id:"find-cells-for-sufficient-capacity",children:[],level:3}],level:2}],f={toc:d};function m(e){var t=e.components,n=(0,a.Z)(e,r);return(0,c.kt)("wrapper",(0,l.Z)({},f,n,{components:t,mdxType:"MDXLayout"}),(0,c.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,c.kt)("p",null,"The following prerequisites apply for the examples of this guide:"),(0,c.kt)("ul",null,(0,c.kt)("li",{parentName:"ul"},"The development environment is set up. For more information, see ",(0,c.kt)(i.Z,{to:(0,o.Z)("/docs/tools/lumos/preparation/setupsystem"),mdxType:"Link"},"Set Up the Development Environment"),"."),(0,c.kt)("li",{parentName:"ul"},"The Lumos packages are installed. For more information, see ",(0,c.kt)(i.Z,{to:(0,o.Z)("/docs/tools/lumos/guides/installlumos"),mdxType:"Link"},"Install Lumos Packages"),".")),(0,c.kt)("h2",{id:"environment"},"Environment"),(0,c.kt)("p",null,"The following examples are verified on Ubuntu 20.04.2. Steps on the other platforms can be adjusted accordingly."),(0,c.kt)("h2",{id:"examples"},"Examples"),(0,c.kt)("h3",{id:"get-cell-minimal-capacity"},"Get Cell Minimal Capacity"),(0,c.kt)("p",null,"The three fields of a CKB cell and the cell itself all take up CKB capacity. The cell must have the capacity that is equal to or more than the total size of information stored in the cell. For more information, see ",(0,c.kt)("a",{parentName:"p",href:"https://nervosnetwork.github.io/docs-new/docs/reference/cell"},"Nervos Docs: Cell"),"."),(0,c.kt)("p",null,"For example, the minimum CKB capacity requirement is 61 CKB (6,100,000,000 shannons) for a common transaction, and 102 CKB (10,200,000,000 shannons) for a DAO deposit transaction."),(0,c.kt)("p",null,"The ",(0,c.kt)("a",{parentName:"p",href:"https://nervosnetwork.github.io/lumos/modules/helpers.html#minimalcellcapacity"},"minimalCellCapacity")," function of the ",(0,c.kt)("inlineCode",{parentName:"p"},"@ckb-lumos/helpers")," package can be used to get the minimal capacity for a cell."),(0,c.kt)("p",null,"Example:"),(0,c.kt)("pre",null,(0,c.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="hellolumos/src/querycells.ts/getMinimalCellCapacity" {4}',title:'"hellolumos/src/querycells.ts/getMinimalCellCapacity"',"{4}":!0},'import { minimalCellCapacity } from "@ckb-lumos/helpers";\n\nexport async function getMinimalCellCapacity(fullcell: Cell) {\n  const result = minimalCellCapacity(fullcell);\n  console.log("The minimal cell capacity is", result);\n}\n')),(0,c.kt)("p",null,"Try the ",(0,c.kt)("inlineCode",{parentName:"p"},"getMinimalCellCapacity")," function in the Node.js REPL mode:"),(0,c.kt)("details",null,(0,c.kt)("summary",null,"CLICK ME"),(0,c.kt)("p",null,(0,c.kt)("pre",null,(0,c.kt)("code",{parentName:"pre",className:"language-shell",metastring:"{1,2,5,8-26,29-51}","{1,2,5,8-26,29-51}":!0},"$ cd hellolumos\n$ node --experimental-repl-await\nWelcome to Node.js v14.0.0.\nType \".help\" for more information.\n> const { querycells } = require(\".\");\nThe server is started.\n# You can use the following cell data directly.\n> const cell = {\n  cell_output: {\n    capacity: '0x1247656167b4',\n    lock: {\n      code_hash: '0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8',\n      hash_type: 'type',\n      args: '0x7e00660b8ab122bca3ba468c5b6eee71f40b7d8e'\n    },\n    type: undefined\n  },\n  out_point: {\n    tx_hash: '0xdcd898c29a2d9dcbaca6c5112bb681d55acb5a557aaf2cbaa1ea2fe561ba3b36',\n    index: '0x0'\n  },\n  block_hash: '0x8030e31e760905f4e2c220f45b653ed73d0bdea5962bd34ca96bc3ea50cbc725',\n  block_number: '0x9a',\n  data: '0x'\n}\n> await querycells.getMinimalCellCapacity(cell);\nThe minimal cell capacity is 6100000000n\n# You can use the following cell data directly.\n> const DAOCell = {\n  cell_output: {\n    capacity: '0x4a817c800',\n    lock: {\n      code_hash: '0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8',\n      hash_type: 'type',\n      args: '0x7e00660b8ab122bca3ba468c5b6eee71f40b7d8e'\n    },\n    type: {\n      code_hash: '0x82d76d1b75fe2fd9a27dfbaa65a039221a380d76c926f378d3f81cf3e7e13f2e',\n      hash_type: 'type',\n      args: '0x'\n    }\n  },\n  out_point: {\n    tx_hash: '0x58f49e100a00742396fa66bcd2541fadcae549b56e75350efaa166d5d5bfacdc',\n    index: '0x0'\n  },\n  block_hash: '0xc9a0077484dbcfa990e0d12b94d137723aec6a9f3ae44e8ed05e19084a076549',\n  block_number: '0x59',\n  data: '0x0000000000000000'\n};\n> await querycells.getMinimalCellCapacity(DAOCell);\nThe minimal cell capacity is 10200000000n\n")))),(0,c.kt)("h3",{id:"get-the-balance-of-an-account"},"Get the Balance of an Account"),(0,c.kt)("p",null,"The balance of an account means the total CKB capacity of the account. For more information, see ",(0,c.kt)(i.Z,{to:(0,o.Z)("/docs/basics/ckbaccount#ckb-capacity-of-an-account"),mdxType:"Link"},"CKB Capacity of an Account"),"."),(0,c.kt)("p",null,"The following example gathers the live (unspent) cells for a specific lock script (the lock script is the ID of an account) and then calculates the total capacity as the balance of the account. "),(0,c.kt)("p",null,"Example:"),(0,c.kt)("pre",null,(0,c.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="hellolumos/src/querycells.ts/getBalancebyLock"',title:'"hellolumos/src/querycells.ts/getBalancebyLock"'},'import { INDEXER } from "./index";\nimport { Cell, Script } from "@ckb-lumos/base";\n\nexport async function getBalancebyLock(lockScript: Script) {\n  let balance = BigInt(0);\n  const collector = INDEXER.collector({ lock: lockScript });\n  const cells: Cell[] = [];\n  for await (const cell of collector.collect()) {\n    cells.push(cell);\n  }\n  balance = cells\n    .map((cell) => BigInt(cell.cell_output.capacity))\n    .reduce((balance, capacity) => (balance = balance += capacity), BigInt(0));\n  console.log("The balance of the account is", balance);\n}\n')),(0,c.kt)("p",null,"Try the ",(0,c.kt)("inlineCode",{parentName:"p"},"GetBalancebyLock")," function in the Node.js REPL mode:"),(0,c.kt)("details",null,(0,c.kt)("summary",null,"CLICK ME"),(0,c.kt)("p",null,(0,c.kt)("pre",null,(0,c.kt)("code",{parentName:"pre",className:"language-shell",metastring:"{1,2,5,7-10}","{1,2,5,7-10}":!0},'$ cd hellolumos\n$ node --experimental-repl-await\nWelcome to Node.js v14.0.0.\nType ".help" for more information.\n> const { accounts, querycells } = require(".");\nThe server is started.\n> const alice = accounts.ALICE;\n> const { parseAddress } = require("@ckb-lumos/helpers");\n> const script = parseAddress(alice.ADDRESS);\n> await querycells.getBalancebyLock(script);\nThe balance of the account is 522545522203302n\n')))),(0,c.kt)("h3",{id:"get-the-sudt-balance-of-an-account"},"Get the SUDT Balance of an Account"),(0,c.kt)("p",null,"The following example collects the cells for a lock script and an SUDT script, and then calculates the total amount of SUDT tokens for the account. "),(0,c.kt)("p",null,"Example:"),(0,c.kt)("pre",null,(0,c.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="hellolumos/src/querycells.ts/getSUDTBalance"',title:'"hellolumos/src/querycells.ts/getSUDTBalance"'},'import { INDEXER } from "./index";\nimport { Cell, Script } from "@ckb-lumos/base";\n\nexport async function getSUDTBalance(lock: Script, sudtType: Script) {\n  let balance = BigInt(0);\n  const collector = INDEXER.collector({ lock, type: sudtType });\n  const cells: Cell[] = [];\n  for await (const cell of collector.collect()) {\n    cells.push(cell);\n  }\n\n  balance = cells\n    .map((cell) => utils.readBigUInt128LE(cell.data))\n    .reduce((balance, amount) => (balance = balance += amount), BigInt(0));\n  console.log("The SUDT balance of the account is", balance);\n}\n')),(0,c.kt)("p",null,"For more information about SUDT and SUDT operations, see ",(0,c.kt)(i.Z,{to:(0,o.Z)("/docs/tools/lumos/guides/buildtransactions#issue-sudt-tokens"),mdxType:"Link"},"Issue SUDT Tokens")," and ",(0,c.kt)(i.Z,{to:(0,o.Z)("/docs/tools/lumos/guides/buildtransactions#transfer-sudt-tokens"),mdxType:"Link"},"Transfer SUDT Tokens"),"."),(0,c.kt)("h3",{id:"find-cells-for-sufficient-capacity"},"Find Cells for Sufficient Capacity"),(0,c.kt)("p",null,"The following example collects a set of cells and the total amount of CKB capacity of the cells is sufficient for the required ",(0,c.kt)("var",null,"amount"),"."),(0,c.kt)("p",null,"Example:"),(0,c.kt)("pre",null,(0,c.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="hellolumos/src/querycells.ts/getBalancebyLock"',title:'"hellolumos/src/querycells.ts/getBalancebyLock"'},'import { INDEXER } from "./index";\nimport { Cell, Script } from "@ckb-lumos/base";\n\nexport const findCellsforSufficientAmount = async (\n  lockScript: Script,\n  amount: BigInt\n): Promise<Cell[]> => {\n  let foundCapacity = BigInt(0);\n  const Cells = [] as Cell[];\n\n  const collector = INDEXER.collector({ lock: lockScript });\n\n  const cells: Cell[] = [];\n  for await (const cell of collector.collect()) {\n    // If the cell has a type script or data, ignore\n    if (!cell.cell_output.type && cell.data === "0x") {\n      cells.push(cell);\n    }\n  }\n\n  for (const cell of cells) {\n    if (foundCapacity < amount) {\n      foundCapacity = foundCapacity + BigInt(cell.cell_output.capacity);\n      Cells.push(cell);\n    }\n    if (foundCapacity > amount) break;\n  }\n\n  if (foundCapacity < amount)\n    throw new Error(`Insufficient capacity cells found`);\n\n  return Cells;\n};\n')),(0,c.kt)("p",null,"Try the ",(0,c.kt)("inlineCode",{parentName:"p"},"findCellsforSufficientAmount")," function in the Node.js REPL mode:"),(0,c.kt)("details",null,(0,c.kt)("summary",null,"CLICK ME"),(0,c.kt)("p",null,(0,c.kt)("pre",null,(0,c.kt)("code",{parentName:"pre",className:"language-shell",metastring:"{1,2,5,7-9,13,50}","{1,2,5,7-9,13,50}":!0},"$ cd hellolumos\n$ node --experimental-repl-await\nWelcome to Node.js v14.0.0.\nType \".help\" for more information.\n> const { accounts, querycells } = require(\".\");\nThe server is started.\n> const bob = accounts.BOB;\n> const { parseAddress } = require(\"@ckb-lumos/helpers\");\n> const script = parseAddress(bob.ADDRESS);\n# Bob owns three cells, and each cell contains 200 CKB in the capacity field.\n# This can be achieved by transferring 600 CKB from Alice to Bob in three times,\n# and 200 CKB each time.\n> await querycells.findCellsbyLock(script);\nFind the cells by lock script:\n[\n  {\n    cell_output: { capacity: '0x4a817c800', lock: [Object], type: undefined },\n    out_point: {\n      tx_hash: '0x22cc789bdaa8e021caa303cf20cfa4063b46a17abd62b31aa2cf712844f984cb',\n      index: '0x0'\n    },\n    block_hash: '0x6d60ae47167a78fbcf254c81b1d6356aceef2feeb4e039fed693c274a83faac1',\n    block_number: '0xf',\n    data: '0x'\n  },\n  {\n    cell_output: { capacity: '0x4a817c800', lock: [Object], type: undefined },\n    out_point: {\n      tx_hash: '0x46e6e4fd23263aa8983f73962faca0bd9d40463c2e42bbcd190249e3ec6bd5f8',\n      index: '0x0'\n    },\n    block_hash: '0x63539ac9bc533bfb16e00cfaf736ebc041442fd3c3c6e8796b53cbdec0fb7af4',\n    block_number: '0x1b',\n    data: '0x'\n  },\n  {\n    cell_output: { capacity: '0x4a817c800', lock: [Object], type: undefined },\n    out_point: {\n      tx_hash: '0x1f279591dca01710f1e5f71480ffe9039887212ade07b025b84a3d0b19f9a2bb',\n      index: '0x0'\n    },\n    block_hash: '0x29acfca00bb07d94791c0f14685d40820ac198b771c894e45755bb55018fa6ea',\n    block_number: '0x21',\n    data: '0x'\n  }\n]\n# Run the findCellsforSufficientAmount function to collect the cells that have a total\n# amount at least 300 CKB. The function returns two cells with the total amount of 400 CKB that is\n# sufficient and more than 300 CKB.\n> await querycells.findCellsforSufficientAmount(script, 30000000000n);\n[\n  {\n    cell_output: { capacity: '0x4a817c800', lock: [Object], type: undefined },\n    out_point: {\n      tx_hash: '0x22cc789bdaa8e021caa303cf20cfa4063b46a17abd62b31aa2cf712844f984cb',\n      index: '0x0'\n    },\n    block_hash: '0x6d60ae47167a78fbcf254c81b1d6356aceef2feeb4e039fed693c274a83faac1',\n    block_number: '0xf',\n    data: '0x'\n  },\n  {\n    cell_output: { capacity: '0x4a817c800', lock: [Object], type: undefined },\n    out_point: {\n      tx_hash: '0x46e6e4fd23263aa8983f73962faca0bd9d40463c2e42bbcd190249e3ec6bd5f8',\n      index: '0x0'\n    },\n    block_hash: '0x63539ac9bc533bfb16e00cfaf736ebc041442fd3c3c6e8796b53cbdec0fb7af4',\n    block_number: '0x1b',\n    data: '0x'\n  }\n]\n")))))}m.isMDXComponent=!0}}]);