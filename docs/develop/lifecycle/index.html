<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.13">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-CPNK56S8G3"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-CPNK56S8G3",{anonymize_ip:!0})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Nervos CKB" href="/docs-new_toolchain/opensearch.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&display=swap">
<script src="/js/extra.js"></script><title data-react-helmet="true">Transaction validation lifecycle | Nervos CKB</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://xying21.github.com/docs-new_toolchain/img/undraw_online.svg"><meta data-react-helmet="true" name="twitter:image" content="https://xying21.github.com/docs-new_toolchain/img/undraw_online.svg"><meta data-react-helmet="true" property="og:url" content="https://xying21.github.com/docs-new_toolchain/docs/develop/lifecycle"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Transaction validation lifecycle | Nervos CKB"><meta data-react-helmet="true" name="description" content="Transactions are the most fundamental entities for interacting with Nervos CKB. When you interact with the CKB, you are submitting state transitions through transactions. This document will explain the lifecycle of CKB transaction validation."><meta data-react-helmet="true" property="og:description" content="Transactions are the most fundamental entities for interacting with Nervos CKB. When you interact with the CKB, you are submitting state transitions through transactions. This document will explain the lifecycle of CKB transaction validation."><link data-react-helmet="true" rel="icon" href="/docs-new_toolchain/img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://xying21.github.com/docs-new_toolchain/docs/develop/lifecycle"><link data-react-helmet="true" rel="alternate" href="https://xying21.github.com/docs-new_toolchain/docs/develop/lifecycle" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://xying21.github.com/docs-new_toolchain/docs/develop/lifecycle" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/docs-new_toolchain/assets/css/styles.3d7242b2.css">
<link rel="preload" href="/docs-new_toolchain/assets/js/runtime~main.4baa6bea.js" as="script">
<link rel="preload" href="/docs-new_toolchain/assets/js/main.cf2d542f.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbar--dark"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/docs-new_toolchain/"><div class="navbar__logo"><img src="/docs-new_toolchain/img/logo.png" alt="Nervos CKB" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/docs-new_toolchain/img/logo.png" alt="Nervos CKB" class="themedImage_TMUO themedImage--dark_uzRr"></div></a><a class="navbar__item navbar__link" href="/docs-new_toolchain/docs/basics/introduction">Basics</a><a class="navbar__item navbar__link" href="/docs-new_toolchain/docs/reference/introduction">Reference</a><a class="navbar__item navbar__link" href="/docs-new_toolchain/docs/labs/introduction">Labs</a><a class="navbar__item navbar__link" href="/docs-new_toolchain/docs/integrate/introduction">Integrate</a><a class="navbar__item navbar__link" href="/docs-new_toolchain/docs/essays/introduction">Essays</a><a class="navbar__item navbar__link" href="/docs-new_toolchain/docs/develop/developer-materials-guide">Develop</a></div><div class="navbar__items navbar__items--right"><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">🌜</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">🌞</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="searchBox_Utm0"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs-new_toolchain/docs/develop/developer-materials-guide">Introduction</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs-new_toolchain/docs/develop/tools/ckb-cli/intro">Tools</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_TwRn" href="/docs-new_toolchain/docs/develop/lifecycle">Tutorials</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs-new_toolchain/docs/develop/lifecycle">Transaction validation lifecycle</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs-new_toolchain/docs/develop/debug">Tips for Debugging CKB Scripts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs-new_toolchain/docs/develop/pprof">Tips for profiling CKB script</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs-new_toolchain/docs/develop/rules">The General Workflow for Constructing a Transaction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs-new_toolchain/docs/develop/dependencies">Script Dependencies</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs-new_toolchain/docs/develop/polyjuice">Technical Bits on Polyjuice</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs-new_toolchain/docs/develop/ckb-core-dev">Tips for CKB Development</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs-new_toolchain/docs/develop/integrity-check">Integrity Check for CKB Release</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs-new_toolchain/docs/develop/mint-sudt-via-contract">Mint SUDT via Contract</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs-new_toolchain/docs/develop/faq">FAQs</a></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Transaction validation lifecycle</h1></header><p>Transactions are the most fundamental entities for interacting with Nervos CKB. When you interact with the CKB, you are submitting state transitions through transactions. This document will explain the lifecycle of CKB transaction validation.</p><img src="/docs-new_toolchain/assets/images/lifecycle-d38b91ad7e2b4a2b31425a2885bd62d0.png" width="300"><h2 class="anchor anchorWithStickyNavbar_y2LR" id="submit-the-transaction-through-rpc">Submit the transaction through RPC<a aria-hidden="true" class="hash-link" href="#submit-the-transaction-through-rpc" title="Direct link to heading">​</a></h2><p>First, a sender constructs a transaction, then submits it through RPC. The transaction will be validated by the <code>outputs_validator</code>  (introduced in v0.27.0) which has been submitted. </p><p>The default validation logic involves checking various things:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">transaction.outputs.all{ |output|</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let script = output.script</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    (script.code_hash == secp256k1_blake160_sighash_all &amp;&amp; script.hash_type == &quot;type&quot; &amp;&amp; script.args.size == 20) ||</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    (script.code_hash == secp256k1_blake160_multisig_all &amp;&amp; script.hash_type == &quot;type&quot; &amp;&amp; （script.args.size == 20 || (script.args.size == 28 &amp;&amp; script.args[20..28].is_valid_since_format))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">transaction.outputs.all{ |output|</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let script = output.type</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    script.is_null || script.code_hash == dao &amp;&amp; script.hash_type == &quot;type&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    || (script.has_lock_period() &amp;&amp; since.is_absolute())</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This validation is intended to prevent improperly constructed transactions, such as mentioned in <em><a href="https://github.com/nervosnetwork/ckb/wiki/Common-Gotchas#nervos-dao" target="_blank" rel="noopener noreferrer">https://github.com/nervosnetwork/ckb/wiki/Common-Gotchas#nervos-dao</a></em> </p><p>Although the node can be configured to <code>passthrough</code> to skip this validation, once the transaction has been submitted to your local node, the node also exports the transaction id, which can then be used to track transaction status.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="verification">Verification<a aria-hidden="true" class="hash-link" href="#verification" title="Direct link to heading">​</a></h2><p>Before the transaction is broadcasted and enters into the mempool, it should be verified and executed locally.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="step-1--resolve">STEP 1 — Resolve<a aria-hidden="true" class="hash-link" href="#step-1--resolve" title="Direct link to heading">​</a></h3><p>Essentially, transaction inputs are just pointers, as shown here:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">struct OutPoint {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    tx_hash:        Byte32,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    index:          Uint32,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>We gather the referenced data through the pointer prior to transaction execution, this process is called “resolve transaction”. We will also need to check that all inputs of this transaction are valid (no duplicate or double-spending).</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="step-2--verify">STEP 2 — Verify<a aria-hidden="true" class="hash-link" href="#step-2--verify" title="Direct link to heading">​</a></h3><p>The process of verification involves checking the following items:       </p><ol><li>version (currently must be 0) </li><li>serialized_size is less than limit <ol><li>pub fn serialized_size(&amp;self) -&gt; usize {
// the offset in TransactionVec header is u32
self.as_slice().len() + molecule::NUMBER_SIZE
// molecule::NUMBER_SIZE = <code>size_of::&lt;u32&gt;() 4</code>
}</li></ol></li><li>inputs are not empty<ol><li>inputs().is_empty() || outputs().is_empty()</li></ol></li><li>inputs are mature<ol><li>For each input and dep, if the referenced output transaction is a cellbase, it must have at least 4 epoch confirmations</li></ol></li><li>capacity<ol><li>sum of inputs’ capacity must less than or equal to outputs’ capacity</li></ol></li><li>duplicate_deps<ol><li>deps should not be duplicated</li></ol></li><li>outputs_data_verifier<ol><li>number of ‘output data&#x27; fields must equal number of outputs</li></ol></li><li>since     <ol><li>‘since’ value must follow the rules described in <a href="https://github.com/nervosnetwork/rfcs/blob/master/rfcs/0017-tx-valid-since/0017-tx-valid-since.md" target="_blank" rel="noopener noreferrer">https://github.com/nervosnetwork/rfcs/blob/master/rfcs/0017-tx-valid-since/0017-tx-valid-since.md</a></li></ol></li></ol><p>Then CKB VM will execute the transaction script and output the number of cycles consumed.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="broadcast-to-the-network">Broadcast to the network<a aria-hidden="true" class="hash-link" href="#broadcast-to-the-network" title="Direct link to heading">​</a></h2><p>If the verification is successful, the current node broadcasts the transaction (with cycles value) to all of its connected peer nodes. </p><p>If verification fails, the transaction is not broadcasted anymore. The transaction flows through various “full nodes”, which repeat the verification process described in the previous step, and check that the cycles value matches the actual cycles consumed when the transaction is verified.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="tx-pool-mempool">Tx-pool (mempool)<a aria-hidden="true" class="hash-link" href="#tx-pool-mempool" title="Direct link to heading">​</a></h2><img src="/docs-new_toolchain/assets/images/mempool-fca4ce93b85d56b6c08191cb272fa76f.png" width="600"><p>CKB uses a two-step process for transaction confirmation. Transactions will be divided into different status (pending and proposed) in the tx-pool. The status of transactions will change when a block is added to the blockchain. When the latest block changes, all transactions in the tx-pool will be re-scanned to ensure they are still valid.</p><p><code>BlockAssembler</code> will fetch proposals and transactions from the pending pool and proposed pool for block template.</p><p>More information about this two-step transaction confirmation process can be found here:
<a href="https://github.com/nervosnetwork/rfcs/blob/master/rfcs/0020-ckb-consensus-protocol/0020-ckb-consensus-protocol.md#two-step-transaction-confirmation" target="_blank" rel="noopener noreferrer">https://github.com/nervosnetwork/rfcs/blob/master/rfcs/0020-ckb-consensus-protocol/0020-ckb-consensus-protocol.md#two-step-transaction-confirmation</a></p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs-new_toolchain/docs/develop/tools/pw-lock"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« <!-- -->PW-lock</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs-new_toolchain/docs/develop/debug"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Tips for Debugging CKB Scripts<!-- --> »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#submit-the-transaction-through-rpc" class="table-of-contents__link toc-highlight">Submit the transaction through RPC</a></li><li><a href="#verification" class="table-of-contents__link toc-highlight">Verification</a><ul><li><a href="#step-1--resolve" class="table-of-contents__link toc-highlight">STEP 1 — Resolve</a></li><li><a href="#step-2--verify" class="table-of-contents__link toc-highlight">STEP 2 — Verify</a></li></ul></li><li><a href="#broadcast-to-the-network" class="table-of-contents__link toc-highlight">Broadcast to the network</a></li><li><a href="#tx-pool-mempool" class="table-of-contents__link toc-highlight">Tx-pool (mempool)</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Foundation</div><ul class="footer__items"><li class="footer__item"><a href="https://www.nervos.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">About Us</a></li></ul></div><div class="col footer__col"><div class="footer__title">Developer</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/nervosnetwork" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a href="https://github.com/nervosnetwork/rfcs/blob/master/rfcs/0002-ckb/0002-ckb.md" target="_blank" rel="noopener noreferrer" class="footer__link-item">Whitepaper</a></li><li class="footer__item"><a href="https://github.com/nervosnetwork/rfcs" target="_blank" rel="noopener noreferrer" class="footer__link-item">RFCs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://discord.gg/AqGTUE9" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://talk.nervos.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Forum</a></li><li class="footer__item"><a href="https://www.reddit.com/r/NervosNetwork/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Reddit</a></li><li class="footer__item"><a href="https://t.me/nervosnetwork" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/nervosnetwork" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li><li class="footer__item"><a href="https://medium.com/nervosnetwork" target="_blank" rel="noopener noreferrer" class="footer__link-item">Medium</a></li><li class="footer__item"><a href="https://www.youtube.com/channel/UCONuJGdMzUY0Y6jrPBOzH7A" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021  Nervos Foundation. All Rights Reserved.</div></div></div></footer></div>
<script src="/docs-new_toolchain/assets/js/runtime~main.4baa6bea.js"></script>
<script src="/docs-new_toolchain/assets/js/main.cf2d542f.js"></script>
</body>
</html>