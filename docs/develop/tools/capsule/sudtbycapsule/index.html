<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.13">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-CPNK56S8G3"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-CPNK56S8G3",{anonymize_ip:!0})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Nervos CKB" href="/develop/opensearch.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&display=swap">
<script src="/js/extra.js"></script><title data-react-helmet="true">Write an SUDT Script by Capsule | Nervos CKB</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://xying21.github.com/develop/img/undraw_online.svg"><meta data-react-helmet="true" name="twitter:image" content="https://xying21.github.com/develop/img/undraw_online.svg"><meta data-react-helmet="true" property="og:url" content="https://xying21.github.com/develop/docs/develop/tools/capsule/sudtbycapsule"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Write an SUDT Script by Capsule | Nervos CKB"><meta data-react-helmet="true" name="description" content="Introduction"><meta data-react-helmet="true" property="og:description" content="Introduction"><link data-react-helmet="true" rel="icon" href="/develop/img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://xying21.github.com/develop/docs/develop/tools/capsule/sudtbycapsule"><link data-react-helmet="true" rel="alternate" href="https://xying21.github.com/develop/docs/develop/tools/capsule/sudtbycapsule" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://xying21.github.com/develop/docs/develop/tools/capsule/sudtbycapsule" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/develop/assets/css/styles.3d7242b2.css">
<link rel="preload" href="/develop/assets/js/runtime~main.9a7d223e.js" as="script">
<link rel="preload" href="/develop/assets/js/main.b81bb0ca.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbar--dark"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/develop/"><div class="navbar__logo"><img src="/develop/img/logo.png" alt="Nervos CKB" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/develop/img/logo.png" alt="Nervos CKB" class="themedImage_TMUO themedImage--dark_uzRr"></div></a><a class="navbar__item navbar__link" href="/develop/docs/basics/introduction">Basics</a><a class="navbar__item navbar__link" href="/develop/docs/reference/introduction">Reference</a><a class="navbar__item navbar__link" href="/develop/docs/labs/introduction">Labs</a><a class="navbar__item navbar__link" href="/develop/docs/integrate/introduction">Integrate</a><a class="navbar__item navbar__link" href="/develop/docs/essays/introduction">Essays</a><a class="navbar__item navbar__link" href="/develop/docs/develop/developer-materials-guide">Develop</a></div><div class="navbar__items navbar__items--right"><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">🌜</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">🌞</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="searchBox_Utm0"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/develop/docs/develop/developer-materials-guide">Introduction</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_TwRn" href="/develop/docs/develop/tools/ckb-cli/intro">Tools</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/develop/docs/develop/tools/ckb-cli/intro">CKB-CLI</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/develop/docs/develop/tools/lumos/introduction/intro">Lumos</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/develop/docs/develop/tools/sdk/intro">CKB SDK</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_TwRn" tabindex="0" href="/develop/docs/develop/tools/capsule/intro">Capsule</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/develop/docs/develop/tools/capsule/intro">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/develop/docs/develop/tools/capsule/sudtbycapsule">Write an SUDT Script by Capsule</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/develop/docs/develop/tools/capsule/capsule-dynamic-loading-tutorial">Dynamic loading in Capsule</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/develop/docs/develop/tools/mercury">Mercury</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/develop/docs/develop/tools/tippy/intro">Tippy</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/develop/docs/develop/tools/ckb-studio">CKB Studio</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/develop/docs/develop/tools/pw-lock">PW-lock</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/develop/docs/develop/lifecycle">Tutorials</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/develop/docs/develop/faq">FAQs</a></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Write an SUDT Script by Capsule</h1></header><h2 class="anchor anchorWithStickyNavbar_y2LR" id="introduction">Introduction<a aria-hidden="true" class="hash-link" href="#introduction" title="Direct link to heading">​</a></h2><p><a href="https://github.com/nervosnetwork/capsule" target="_blank" rel="noopener noreferrer">Capsule</a> is a set of tools for Rust developers to develop scripts on CKB which covers the entire lifecycle of script development: writing,debugging,testing and deployment. We aim to improve the development experience of Rust developers.</p><p>In this tutorial, you will learn how to write a SUDT script using Capsule. SUDT is the abbreviation of Simple User Defined Token which defines a minimal standard that contains what’s absolutely needed for dapp developers to issue custom tokens on Nervos CKB. You can refer to <a href="https://talk.nervos.org/t/rfc-simple-udt-draft-spec/4333" target="_blank" rel="noopener noreferrer">RFC: Simple UDT Draft Spec</a> for more details.</p><p>We expect that:</p><ul><li>You are Rust developers and generally familiar with software development, writing code, and running your code.</li><li>You are generally familiar with Nervos CKB and have completed the <a href="/develop/docs/basics/guides/devchain">How to use a development blockchain</a></li><li>You are open to learning about the bleeding edge of blockchain development</li></ul><p>If you run into an issue on this tutorial you can <a href="https://github.com/nervosnetwork/capsule" target="_blank" rel="noopener noreferrer">create a new issue</a> or contact us on <a href="https://talk.nervos.org/" target="_blank" rel="noopener noreferrer">Nervos talk</a> or <a href="https://discord.gg/n6tx7uC" target="_blank" rel="noopener noreferrer">Discord</a>. </p><p>What you will be doing:</p><ul><li>Prepare to write the SUDT script </li><li>Write a SUDT script</li><li>Testing</li><li>Deployment </li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="prepare-to-write-the-sudt-script">Prepare to write the SUDT script<a aria-hidden="true" class="hash-link" href="#prepare-to-write-the-sudt-script" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="run-a-dev-chain-and-ckb-cli">Run a dev chain and ckb-cli<a aria-hidden="true" class="hash-link" href="#run-a-dev-chain-and-ckb-cli" title="Direct link to heading">​</a></h3><p>You should be able to run a dev chain and know about how to use <code>ckb-cli</code> to send transactions.  If you do not, please refer to this tutorial：<a href="/develop/docs/basics/guides/devchain">How to use a development blockchain</a>.  Please don&#x27;t forget to add <code>ckb-cli</code> to the  PATH environment variable</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="install-capsule">Install Capsule<a aria-hidden="true" class="hash-link" href="#install-capsule" title="Direct link to heading">​</a></h3><p>To use capsule, you need to install Docker. It is recommended to install the latest version of Docker:</p><ul><li><a href="https://docs.docker.com/get-docker/" target="_blank" rel="noopener noreferrer">Install Docker</a></li></ul><p>Note: The current user must have permission to manage Docker instances. For more information, see <a href="https://docs.docker.com/engine/install/linux-postinstall/#manage-docker-as-a-non-root-user" target="_blank" rel="noopener noreferrer">Manage Docker as a non-root user</a>.</p><p>Now you can proceed to install Capsule. It is recommended to download the binary <a href="https://github.com/nervosnetwork/capsule/releases" target="_blank" rel="noopener noreferrer">here</a>.</p><p>Or you can install Capsule from it&#x27;s source:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">cargo install capsule --git https://github.com/nervosnetwork/capsule.git --tag v0.1.3</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Then check if it works with the following command:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">capsule check</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><details class="details_Q743 alert alert--info details_h+cY" data-collapsed="true"><summary>(click here to view response)</summary><div><div class="collapsibleContent_K5uX">```bash ------------------------------ docker    installed ckb-cli    installed ------------------------------ ```</div></div></details><h3 class="anchor anchorWithStickyNavbar_y2LR" id="create-a-project">Create a project<a aria-hidden="true" class="hash-link" href="#create-a-project" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">capsule new my-sudt</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><details class="details_Q743 alert alert--info details_h+cY" data-collapsed="true"><summary>(click here to view response)</summary><div><div class="collapsibleContent_K5uX">```bash New project &quot;my-sudt&quot; Created file &quot;capsule.toml&quot; Created file &quot;deployment.toml&quot; Created file &quot;README.md&quot; Created file &quot;Cargo.toml&quot; Created &quot;/PATH/my-sudt&quot; Created binary (application) `my-sudt` package Created contract &quot;my-sudt&quot; Created tests Created binary (application) `tests` package Done ```</div></div></details><p>You can check the project’s layout：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">ls my-sudt</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><details class="details_Q743 alert alert--info details_h+cY" data-collapsed="true"><summary>(click here to view response)</summary><div><div class="collapsibleContent_K5uX">```bash<p>build  capsule.toml  Cargo.toml  contracts  deployment.toml  migrations  README.md  tests</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;/details&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">The default contract is under `my-sudt/contracts/my-sudt` directory which is a normal cargo project:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ls my-sudt/contracts/my-sudt</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;details&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;summary&gt;(click here to view response)&lt;/summary&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">```bash</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Cargo.toml  src</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></div></div></details><p>You can open <code>my-sudt/contracts/my-sudt/src/main.rs</code> to see some pre-generated code:</p><div class="codeBlockContainer_J+bg language-rust"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#![no_std]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#![no_main]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#![feature(lang_items)]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#![feature(alloc_error_handler)]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#![feature(panic_info_message)]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Import from `core` instead of from `std` since we are in no-std mode</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">use core::result::Result;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Import heap related library from `alloc`</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// https://doc.rust-lang.org/alloc/index.html</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">use alloc::{vec, vec::Vec};</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Import CKB syscalls and structures</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// https://nervosnetwork.github.io/ckb-std/riscv64imac-unknown-none-elf/doc/ckb_std/index.html</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">use ckb_std::{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    entry,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    default_alloc,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    debug,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    high_level::{load_script, load_tx_hash},</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    error::SysError,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ckb_types::{bytes::Bytes, prelude::*},</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">};</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">entry!(entry);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">default_alloc!();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/// Program entry</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fn entry() -&gt; i8 {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // Call main function and return error code</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    match main() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        Ok(_) =&gt; 0,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        Err(err) =&gt; err as i8,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/// Error</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#[repr(i8)]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">enum Error {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    IndexOutOfBound = 1,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ItemMissing,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    LengthNotEnough,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Encoding,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // Add customized errors here...</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">impl From&lt;SysError&gt; for Error {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    fn from(err: SysError) -&gt; Self {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        use SysError::*;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        match err {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            IndexOutOfBound =&gt; Self::IndexOutOfBound,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            ItemMissing =&gt; Self::ItemMissing,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            LengthNotEnough(_) =&gt; Self::LengthNotEnough,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            Encoding =&gt; Self::Encoding,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            Unknown(err_code) =&gt; panic!(&quot;unexpected sys error {}&quot;, err_code),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fn main() -&gt; Result&lt;(), Error&gt; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // remove below examples and write your code here</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let script = load_script()?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let args: Bytes = script.args().unpack();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    debug!(&quot;script args is {:?}&quot;, args);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let tx_hash = load_tx_hash()?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    debug!(&quot;tx hash is {:?}&quot;, tx_hash);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let _buf: Vec&lt;_&gt; = vec![0u8; 32];</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Ok(())</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="build-the-project">Build the project<a aria-hidden="true" class="hash-link" href="#build-the-project" title="Direct link to heading">​</a></h3><p>Enter into the project  <code>my-sudt</code> and build it.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">cd my-sudt</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">capsule build</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><details class="details_Q743 alert alert--info details_h+cY" data-collapsed="true"><summary>(click here to view response)</summary><div><div class="collapsibleContent_K5uX">```bash<p>Building contract my-sudt
Updating crates.io index
Compiling cc v1.0.56
Compiling cfg-if v0.1.10
Compiling buddy-alloc v0.3.0
Compiling molecule v0.6.0
Compiling ckb-allocator v0.1.1
Compiling ckb-standalone-types v0.0.1-pre.1
Compiling ckb-std v0.4.1
Compiling my-sudt v0.1.0 (/code/contracts/my-sudt)
Finished dev <!-- -->[unoptimized + debuginfo]<!-- --> target(s) in 8.73s
Done</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;/details&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">You will find a new generated contract binary in the `build/debug` directory:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ls build/debug</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;details&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;summary&gt;(click here to view response)&lt;/summary&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">```bash</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">my-sudt</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></div></div></details><p>You&#x27;re all done? Great, let&#x27;s get coding.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="write-a-sudt-script">Write a SUDT script<a aria-hidden="true" class="hash-link" href="#write-a-sudt-script" title="Direct link to heading">​</a></h2><p>SUDT scripts can be in <strong>owner mode</strong> and <strong>normal mode</strong> which include different verification rules, we should deal with that when we&#x27;re coding.</p><ul><li><strong>owner mode</strong>：If one of the transaction input has a lock script matching the SUDT script argument, the SUDT script will be in owner mode. We don’t need to perform checks, the owner can perform any operations such as issuing more SUDTs or burning SUDTs. </li><li><strong>normal mode：</strong>Otherwise, the SUDT script will be in normal mode. We need to ensure the sum of all inputs’ capacity is not smaller than the sum of all outputs capacity. Please note that only one type of SUDT can be issued for each unique lock script. </li></ul><p>The script is consisted of four parts：load script、check inputs、load inputs / outputs UDT amount、error handling. We should check the used libraries before coding.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="check-the-used-libraries">Check the used libraries<a aria-hidden="true" class="hash-link" href="#check-the-used-libraries" title="Direct link to heading">​</a></h3><p>Open <code>contracts/my-sudt/Cargo.toml</code>, we already have a dependency:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">[dependencies]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ckb-std = &quot;0.4.1&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><code>ckb-std</code> is a crate used to handling CKB syscalls.</li><li><code>ckb-standalone-types</code> is a crate which re-exported as the <code>ckb_std::ckb_types</code> provides the definition of CKB structures.</li></ul><p>You may refer to <a href="https://github.com/nervosnetwork/capsule/wiki/Rust-libraries" target="_blank" rel="noopener noreferrer">Rust libraries</a> for more useful crates. We can only use crates which supports <code>no-std</code> in scripts.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="load-script">Load Script<a aria-hidden="true" class="hash-link" href="#load-script" title="Direct link to heading">​</a></h3><p>At the beginning of the script, we need to check the SUDT’s mode, if it is owner mode, we simply skip the verification code and return <code>0</code>, which represents the verification is successful, otherwise we check the amount of UDT.</p><p>To achieve this, we need to load <code>args</code> of the current script, which the generated code already did for us. So we just remove the unused lines from the <code>main</code> function.</p><p>In the code below, we load the current script(SUDT)&#x27;s args field, and invoke <code>check_owner_mode</code> which we have not defined yet.</p><p>Notice since we are using no-std Rust, we can&#x27;t directly use the <code>std</code> in the code. Instead, we need to import the <code>Vec</code> struct from the <a href="https://doc.rust-lang.org/stable/alloc/index.html" target="_blank" rel="noopener noreferrer">alloc</a> crate, which is a rust builtin crate contains heap related structs.</p><div class="codeBlockContainer_J+bg language-rust"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">fn main() -&gt; Result&lt;(), Error&gt; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // load current script</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // check verification branch is owner mode or normal mode</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let script = load_script()?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let args: Bytes = script.args().unpack();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // unpack the Script#args field</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let args: Vec&lt;u8&gt; = script.args().unpack();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // return success if owner mode is true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if check_owner_mode(&amp;args)? {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        return Ok(());</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // more verifications ...</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    return Ok(());</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="check-inputs">Check inputs<a aria-hidden="true" class="hash-link" href="#check-inputs" title="Direct link to heading">​</a></h3><p>Now we should  check the owner mode status by defining the <code>check_owner_mode</code> function：</p><p>We need to load every input&#x27;s lock hash and compare it to the script&#x27;s args. If we find an input&#x27;s lock hash corresponds to the script&#x27;s args, we are in owner mode; otherwise, we iterate all the inputs and finally got an <code>IndexOutOfBound</code> error, which means we are in normal mode.</p><p>We use <a href="https://nervosnetwork.github.io/ckb-std/riscv64imac-unknown-none-elf/doc/ckb_std/high_level/fn.load_cell_lock_hash.html" target="_blank" rel="noopener noreferrer">load_cell_lock_hash</a> to load cell&#x27;s lock hash from CKB. The <code>Source::Input</code> and <code>i</code> args denote we load <code>input</code> from <code>i-th</code> inputs.</p><p>The error <code>SysError::IndexOutOfBound</code> represents that we request an index that does not exist, which means we cannot find a matched input cell, so we return <code>Ok(false)</code>.</p><div class="codeBlockContainer_J+bg language-rust"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">use ckb_std::{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    high_level::{load_cell_lock_hash},</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ckb_constants::Source,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">};</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fn check_owner_mode(args: &amp;Bytes) -&gt; Result&lt;bool, Error&gt; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // With owner lock script extracted, we will look through each input in the</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // current transaction to see if any unlocked cell uses owner lock.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    for i in 0.. {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // check input&#x27;s lock_hash with script args</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        let lock_hash = match load_cell_lock_hash(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            i,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            Source::Input,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        ) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            Ok(lock_hash) =&gt; lock_hash,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            Err(SysError::IndexOutOfBound) =&gt; return Ok(false),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            Err(err) =&gt; return Err(err.into()),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // invalid length of loaded data</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        if args[..] == lock_hash[..] {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">           return Ok(true);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Ok(false)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="load-inputs--outputs-udt-amount">Load inputs / outputs UDT amount<a aria-hidden="true" class="hash-link" href="#load-inputs--outputs-udt-amount" title="Direct link to heading">​</a></h3><p>If the owner mode is <code>false</code>, we should continue the verification: check the total input SUDT amount is greater than or equals to the total output SUDT amount.</p><ul><li><p>Define two methods:</p><ul><li><code>collect_inputs_amount</code> ：collect total input SUDT amount</li><li><code>collect_outputs_amount</code> ：collect total output SUDT amount.</li></ul></li><li><p>Since we aim to read all SUDT inputs which type is the current script(SUDT), we  can use <code>Source::GroupInput</code> instead of  <code>Source::Input</code>.</p></li><li><p><code>Source::GroupInput</code> and <code>i</code>   means load the <code>i-th</code> input from the &quot;input group&quot;. </p></li></ul><p>Tips：</p><ul><li>By using <code>Source::GroupInput</code>  in the syscall, CKB verification engine will automatically group the inputs/outputs by <code>lock</code> and <code>type</code> script.</li><li>The data type of SUDT is  <code>u128</code>, which is 16 bytes so we use the 16 bytes buffer.</li><li><code>i-th</code> input of <code>Source::Input</code>(index of all inputs) may be or may not be the same cell of the <code>i-th</code> input of <code>Source::GroupInput</code> (index of inputs which lock/type is the current script).</li></ul><div class="codeBlockContainer_J+bg language-rust"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">const UDT_LEN: usize = 16;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fn collect_inputs_amount() -&gt; Result&lt;u128, Error&gt; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // let&#x27;s loop through all input cells containing current UDTs,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // and gather the sum of all input tokens.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let mut inputs_amount: u128 = 0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let mut buf = [0u8; UDT_LEN];</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // u128 is 16 bytes</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    for i in 0.. {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        let data = match load_cell_data(i, Source::GroupInput) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            Ok(data) =&gt; data,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            Err(SysError::IndexOutOfBound) =&gt; break,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            Err(err) =&gt; return Err(err.into()),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        if data.len() != UDT_LEN {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            return Err(Error::Encoding);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        buf.copy_from_slice(&amp;data);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        inputs_amount += u128::from_le_bytes(buf);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Ok(inputs_amount)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The <code>collect_outputs_amount</code> function is similar, except we load data from outputs:</p><div class="codeBlockContainer_J+bg language-rust"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">fn collect_outputs_amount() -&gt; Result&lt;u128, Error&gt; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // With the sum of all input UDT tokens gathered, let&#x27;s now iterate through</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // output cells to grab the sum of all output UDT tokens.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let mut outputs_amount: u128 = 0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let mut i = 0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // u128 is 16 bytes</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let mut buf = [0u8; UDT_LEN];</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    for i in 0.. {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        let data = match load_cell_data(i, Source::GroupOutput) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            Ok(data) =&gt; data,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            Err(SysError::IndexOutOfBound) =&gt; break,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            Err(err) =&gt; return Err(err.into()),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        if data.len() != UDT_LEN {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            return Err(Error::Encoding);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        buf.copy_from_slice(&amp;data);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        outputs_amount += u128::from_le_bytes(buf);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Ok(outputs_amount)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>Update the <code>main</code> function to check inputs / outputs UDT amount:</li></ul><div class="codeBlockContainer_J+bg language-rust"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/// Error</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#[repr(i8)]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">enum Error {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    IndexOutOfBound = 1,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ItemMissing,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    LengthNotEnough,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Encoding,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Amount</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fn main() -&gt; Result&lt;(), Error&gt; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let script = load_script()?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let args: Bytes = script.args().unpack();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // return success if owner mode is true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if check_owner_mode(&amp;args)? {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        return Ok(());</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let inputs_amount = collect_inputs_amount()?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let outputs_amount = collect_outputs_amount()?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if inputs_amount &lt; outputs_amount {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        return Err(Error::Amount);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Ok(())</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="use-iterator-to-query-cells">Use Iterator to query cells<a aria-hidden="true" class="hash-link" href="#use-iterator-to-query-cells" title="Direct link to heading">​</a></h3><p>In the previous code, we use <code>for</code> loop to iterate inputs and outputs, since iteration over cells is a common pattern in CKB programming, <code>ckb-std</code> provides a high-level interface <a href="https://nervosnetwork.github.io/ckb-std/riscv64imac-unknown-none-elf/doc/ckb_std/high_level/struct.QueryIter.html" target="_blank" rel="noopener noreferrer">QueryIter</a> to handle it.</p><p>QueryIter needs two args, the first is a loading function, the seconds is <code>Source</code>. This is an example to load all grouped inputs cells data <code>QueryIter::new(load_cell_data, Source::GroupInput)</code>.</p><p>Rewrite our functions:</p><div class="codeBlockContainer_J+bg language-rust"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">fn check_owner_mode(args: &amp;Bytes) -&gt; Result&lt;bool, Error&gt; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // With owner lock script extracted, we will look through each input in the</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // current transaction to see if any unlocked cell uses owner lock.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let is_owner_mode = QueryIter::new(load_cell_lock_hash, Source::Input)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .find(|lock_hash| args[..] == lock_hash[..]).is_some();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Ok(is_owner_mode)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fn collect_inputs_amount() -&gt; Result&lt;u128, Error&gt; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // let&#x27;s loop through all input cells containing current UDTs,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // and gather the sum of all input tokens.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let mut buf = [0u8; UDT_LEN];</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let udt_list = QueryIter::new(load_cell_data, Source::GroupInput)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .map(|data|{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            if data.len() == UDT_LEN {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                buf.copy_from_slice(&amp;data);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                // u128 is 16 bytes</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                Ok(u128::from_le_bytes(buf))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                Err(Error::Encoding)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }).collect::&lt;Result&lt;Vec&lt;_&gt;, Error&gt;&gt;()?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Ok(udt_list.into_iter().sum::&lt;u128&gt;())</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fn collect_outputs_amount() -&gt; Result&lt;u128, Error&gt; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // With the sum of all input UDT tokens gathered, let&#x27;s now iterate through</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // output cells to grab the sum of all output UDT tokens.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let mut buf = [0u8; UDT_LEN];</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let udt_list = QueryIter::new(load_cell_data, Source::GroupOutput)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .map(|data|{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            if data.len() == UDT_LEN {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                buf.copy_from_slice(&amp;data);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                // u128 is 16 bytes</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                Ok(u128::from_le_bytes(buf))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                Err(Error::Encoding)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }).collect::&lt;Result&lt;Vec&lt;_&gt;, Error&gt;&gt;()?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Ok(udt_list.into_iter().sum::&lt;u128&gt;())</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Now we have finished the SUDT script, you may refer to <a href="https://github.com/jjyr/my-sudt/blob/master/contracts/my-sudt/src/main.rs" target="_blank" rel="noopener noreferrer">Full code of my-sudt</a> to check the full script code. If you are interested, you may also check <a href="https://github.com/nervosnetwork/ckb-miscellaneous-scripts/blob/master/c/simple_udt.c" target="_blank" rel="noopener noreferrer">the SUDT script written in C</a>.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="build-the-project-1">Build the project<a aria-hidden="true" class="hash-link" href="#build-the-project-1" title="Direct link to heading">​</a></h3><p>Run <code>capsule build</code> under the project directory to build the script.If no error occurred, we can find the script binary at <code>my-usdt/build/debug/my-sudt</code>. </p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="testing">Testing<a aria-hidden="true" class="hash-link" href="#testing" title="Direct link to heading">​</a></h2><p>We will use the <code>ckb-testtool</code> crate to construct transactions and context for our testing.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="check-the-default-tests">Check the default tests<a aria-hidden="true" class="hash-link" href="#check-the-default-tests" title="Direct link to heading">​</a></h3><p>When create the project <code>my-sudt</code>,<code>capsule</code>  have generated the default tests.The default tests create mock cells and unlock them for testing.</p><p>Use  <code>capsule build</code> under the project directory to build the script,
then use <code>capsule test</code> to run the default tests.We will find the error message:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">failures:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">---- tests::test_basic stdout ----</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">thread &#x27;tests::test_basic&#x27; panicked at &#x27;pass verification: Error { kind: ValidationFailure(4)Script }&#x27;, tests/src/tests.rs:52:5</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">failures:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    tests::test_basic</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The error number <code>4</code> in <code>Error { kind: ValidationFailure(4)</code>  refers to <code>Error::Encoding</code>, which means the cell’s data type is not <code>u128</code>. </p><p>Let’s check the default tests code  <code>tests/src/tests.rs</code>  to find out how to write the tests, then we can write new tests adapted <code>my-sudt</code>：</p><ul><li>In the beginning part, initialize the  <code>Context</code> which is a structure to simulate the chain environment. We can use <code>Context</code> to deploy exists cells and mock block headers.<code>deploy_contract</code> will return the  <code>out_point</code> of the script.</li></ul><div class="codeBlockContainer_J+bg language-rust"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">// deploy contract</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let mut context = Context::default();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let contract_bin: Bytes = Loader::default().load_binary(&quot;my-sudt&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let contract_out_point = context.deploy_contract(contract_bin);</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>Then <code>build_script</code> is called with the script&#x27;s <code>out_point</code> , this function returns the <code>Script</code> which uses our script as the code. <code>create_cell</code> creates an existing cell in the context, which uses our script as the <code>lock_script</code>.</li></ul><p><em>Please note the default tests assume the script is a lock_script, but in our case, <code>my-sudt</code> is a type_script. We&#x27;ll fix it later.</em></p><div class="codeBlockContainer_J+bg language-rust"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">// prepare scripts</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let lock_script = context.build_script(&amp;contract_out_point, Default::default()).expect(&quot;script&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let lock_script_dep = CellDep::new_builder().out_point(contract_out_point).build();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // prepare cells</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let input_out_point = context.create_cell(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        CellOutput::new_builder()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            .capacity(1000u64.pack())</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            .lock(lock_script.clone())</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            .build(),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        Bytes::new(),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    );</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let input = CellInput::new_builder()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .previous_output(input_out_point)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .build();</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>After that, build two outputs cells and a transaction structure.It is necessary to include  <code>cell_deps</code> field in the transaction which should contain all the referenced scripts, in this case, we can only refer to <code>my-sudt</code>.  <code>complete_tx</code>  also implement <code>cell_deps</code>, while the field is already completed manually, this line is not necessary.</li></ul><p>Please note that the  transaction&#x27;s <code>outputs_data</code> must have the same length with the <code>outputs</code>, even the data is empty.</p><div class="codeBlockContainer_J+bg language-rust"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">let outputs = vec![</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        CellOutput::new_builder()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            .capacity(500u64.pack())</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            .lock(lock_script.clone())</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            .build(),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        CellOutput::new_builder()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            .capacity(500u64.pack())</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            .lock(lock_script)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            .build(),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ];</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let outputs_data = vec![Bytes::new(); 2];</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // build transaction</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let tx = TransactionBuilder::default()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .input(input)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .outputs(outputs)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .outputs_data(outputs_data.pack())</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .cell_dep(lock_script_dep)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .build();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let tx = context.complete_tx(tx);</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>Finally, verify the transaction:</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">// run</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    context</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .verify_tx(&amp;tx, MAX_CYCLES)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .expect(&quot;pass verification&quot;);</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="write-new-tests">Write new tests<a aria-hidden="true" class="hash-link" href="#write-new-tests" title="Direct link to heading">​</a></h3><p>We should create mock SUDT cells and spend them for testing SUDT verification.
As <code>my-sudt</code> script is a <code>type_script</code> we need another script as <code>lock_script</code> for mock cells, it is recommended to use <code>always success</code> script returned <code>0</code>. <code>always success</code> is built-in in the <code>ckb-testtool</code>.</p><div class="codeBlockContainer_J+bg language-rust"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">use ckb_testtool::{builtin::ALWAYS_SUCCESS, context::Context};</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // deploy always_success script</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let always_success_out_point = context.deploy_contract(ALWAYS_SUCCESS.clone());</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Before writing the code, let&#x27;s think about our  test cases:</p><ol><li>Return success when input tokens equals to output tokens.</li><li>Return success when input tokens is greater than output tokens.</li><li>Return failure when input tokens is less than output tokens.</li><li>Return success when input tokens is less than output tokens with <code>owner mode</code> activated.</li></ol><ul><li><p>Define <code>build_test_context</code> to build transactions. There are three args: </p><ul><li>The data type of  <code>inputs_token</code> and <code>outputs_token</code>  is  <code>u128</code>. The function can generate SUDT inputs cells and outputs cells according to the two args.</li><li><code>is_owner_mode</code> refers to the current transaction is in SUDT owner mode or normal mode.</li></ul></li><li><p>Deploy the SUDT and <code>always-success</code> scripts.</p></li></ul><p>Please note that if <code>is_owner_mode</code> is true, we will set <code>lock_script</code>&#x27;s <code>lock_hash</code> as <code>owner script hash</code>; otherwise, we will set <code>[0u8; 32]</code> which implies can&#x27;t enter into owner mode.</p><div class="codeBlockContainer_J+bg language-rust"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">fn build_test_context(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    inputs_token: Vec&lt;u128&gt;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    outputs_token: Vec&lt;u128&gt;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    is_owner_mode: bool,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">) -&gt; (Context, TransactionView) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // deploy my-sudt script</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let mut context = Context::default();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let sudt_bin: Bytes = Loader::default().load_binary(&quot;my-sudt&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let sudt_out_point = context.deploy_contract(sudt_bin);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // deploy always_success script</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let always_success_out_point = context.deploy_contract(ALWAYS_SUCCESS.clone());</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // build lock script</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let lock_script = context</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .build_script(&amp;always_success_out_point, Default::default())</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .expect(&quot;script&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let lock_script_dep = CellDep::new_builder()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .out_point(always_success_out_point)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .build();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // build sudt script</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let sudt_script_args: Bytes = if is_owner_mode {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // use always_success script hash as owner&#x27;s lock</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        let lock_hash: [u8; 32] = lock_script.calc_script_hash().unpack();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        lock_hash.to_vec().into()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // use zero hash as owner&#x27;s lock which implies we can never enter owner mode</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        [0u8; 32].to_vec().into()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let sudt_script = context</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .build_script(&amp;sudt_out_point, sudt_script_args)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .expect(&quot;script&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let sudt_script_dep = CellDep::new_builder().out_point(sudt_out_point).build();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    //... more code below</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">//}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>Build inputs and outputs according to the <code>inputs_token</code> and <code>outputs_token</code> </li></ul><div class="codeBlockContainer_J+bg language-rust"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">// ...</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // prepare inputs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // assign 1000 Bytes to per input</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let input_ckb = Capacity::bytes(1000).unwrap().as_u64();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let inputs = inputs_token.iter().map(|token| {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        let input_out_point = context.create_cell(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            CellOutput::new_builder()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                .capacity(input_ckb.pack())</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                .lock(lock_script.clone())</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                .type_(Some(sudt_script.clone()).pack())</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                .build(),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            token.to_le_bytes().to_vec().into(),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        let input = CellInput::new_builder()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            .previous_output(input_out_point)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            .build();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        input</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // prepare outputs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let output_ckb = input_ckb * inputs_token.len() as u64 / outputs_token.len() as u64;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let outputs = outputs_token.iter().map(|_token| {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        CellOutput::new_builder()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            .capacity(output_ckb.pack())</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            .lock(lock_script.clone())</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            .type_(Some(sudt_script.clone()).pack())</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            .build()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let outputs_data: Vec&lt;_&gt; = outputs_token</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .iter()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .map(|token| Bytes::from(token.to_le_bytes().to_vec()))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .collect();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // ...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>Finally construct the transaction and return it with context.</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">// build transaction</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let tx = TransactionBuilder::default()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .inputs(inputs)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .outputs(outputs)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .outputs_data(outputs_data.pack())</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .cell_dep(lock_script_dep)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .cell_dep(sudt_script_dep)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .build();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    (context, tx)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Now the helper function <code>build_test_context</code> is finished, we can write our tests: </p><div class="codeBlockContainer_J+bg language-rust"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#[test]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fn test_basic() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let (mut context, tx) = build_test_context(vec![1000], vec![400, 600], false);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let tx = context.complete_tx(tx);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // run</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    context</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .verify_tx(&amp;tx, MAX_CYCLES)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .expect(&quot;pass verification&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#[test]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fn test_destroy_udt() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let (mut context, tx) = build_test_context(vec![1000], vec![800, 100, 50], false);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let tx = context.complete_tx(tx);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // run</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    context</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .verify_tx(&amp;tx, MAX_CYCLES)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .expect(&quot;pass verification&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#[test]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fn test_create_sudt_without_owner_mode() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let (mut context, tx) = build_test_context(vec![1000], vec![1200], false);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let tx = context.complete_tx(tx);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // run</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let err = context.verify_tx(&amp;tx, MAX_CYCLES).unwrap_err();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    assert_error_eq!(err, ScriptError::ValidationFailure(ERROR_AMOUNT));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#[test]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fn test_create_sudt_with_owner_mode() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let (mut context, tx) = build_test_context(vec![1000], vec![1200], true);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let tx = context.complete_tx(tx);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // run</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    context</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .verify_tx(&amp;tx, MAX_CYCLES)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .expect(&quot;pass verification&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>You may refer to <a href="https://github.com/jjyr/my-sudt/blob/master/tests/src/tests.rs" target="_blank" rel="noopener noreferrer">my-sudt tests</a> for the full tests. Run <code>capsule test</code>  all tests will be passed.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="deployment">Deployment<a aria-hidden="true" class="hash-link" href="#deployment" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="run-a-dev-chain-and-ckb-cli-1">Run a dev chain and ckb-cli<a aria-hidden="true" class="hash-link" href="#run-a-dev-chain-and-ckb-cli-1" title="Direct link to heading">​</a></h3><p>You should be running a dev chain and know about how to use <code>ckb-cli</code> to send transactions before deployment. </p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="deploy">Deploy<a aria-hidden="true" class="hash-link" href="#deploy" title="Direct link to heading">​</a></h3><ol><li><p>Update the deployment configurations</p><p>Open  <code>deployment.toml</code> :</p><ul><li><p><code>cells</code>  describes which cells to be deployed.</p><ul><li><code>name</code>: Define the reference name used in the deployment configuration.</li><li><code>enable_type_id</code> : If it is set to <code>true</code> means create a <code>type_id</code> for the cell.</li><li><code>location</code> :  Define the script binary path.</li></ul></li><li><p><code>dep_groups</code>  describes which dep_groups to be created. Dep Group is a cell which bundles several cells as its members. When a dep group cell is used in <code>cell_deps</code>, it has the same effect as adding all its members into <code>cell_deps</code>. In our case, we don’t need <code>dep_groups</code>.</p></li><li><p><code>lock</code>  describes the <code>lock</code> field of the new deployed cells.It is  recommended to set <code>lock</code> to the deployer&#x27;s address(an address that you can unlock) in the dev chain and in the testnet, which is easier to update the script.</p></li></ul></li><li><p>Uncomment the configuration file and replace the cell name and location with <code>my-usdt</code>.</p></li></ol><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># [[cells]]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># name = &quot;my_cell&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># enable_type_id = false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># location = { file = &quot;build/release/my_cell&quot; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># # Dep group cells</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># [[dep_groups]]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># name = &quot;my_dep_group&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># cells = [</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#   &quot;my_cell&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#   &quot;secp256k1_data&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># # Replace with your own lock if you want to unlock deployed cells.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># # The deployment code_hash is secp256k1 lock</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># [lock]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># code_hash = &quot;0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># args = &quot;0x0000000000000000000000000000000000000000&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># hash_type = &quot;type&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ol start="3"><li>Build release version of the script</li></ol><ul><li>The release version of script  doesn’t  include debug symbols which makes the size smaller.</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">capsule build --release</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ol start="4"><li>Deploy the script </li></ol><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">capsule deploy --address &lt;ckt1....&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>If the <code>ckb-cli</code> has been installed and dev-chain RPC is connectable, you will see the <code>deployment plan</code>:</p><ul><li><code>new_occupied_capacity</code> and <code>total_occupied_capacity</code>  refer how much CKB to store cells and data.</li><li><code>txs_fee_capacity</code> refers how much CKB to pay the transaction fee.</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Deployment plan:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">---</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">migrated_capacity: 0.0 (CKB)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">new_occupied_capacity: 33629.0 (CKB)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">txs_fee_capacity: 0.0001 (CKB)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">total_occupied_capacity: 33629.0 (CKB)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">recipe:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  cells:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: my-sudt</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      index: 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      tx_hash: 0x8b496cb19018c475cdc4605ee9cef83cbfe578dce4f81f3367395906eba52c29</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      occupied_capacity: 33629.0 (CKB)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      data_hash: 0xaa3d472025e6afefdf3f65c5f9beefd206b4283b30551baef83cbb4762e6d397</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      type_id: ~</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  dep_groups: []</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Confirm deployment? (Yes/No)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ol start="5"><li>Type <code>yes</code> or <code>y</code>  and input the password to unlock the account.</li></ol><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">send cell_tx 8b496cb19018c475cdc4605ee9cef83cbfe578dce4f81f3367395906eba52c29</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Deployment complete</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Now the SUDT script has been deployed, you can refer to this script by using <code>tx_hash: 0xaa3d472025e6afefdf3f65c5f9beefd206b4283b30551baef83cbb4762e6d397 index: 0</code> as <code>out_point</code>(your <code>tx_hash</code> should be another value).</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="migration">Migration<a aria-hidden="true" class="hash-link" href="#migration" title="Direct link to heading">​</a></h3><p>If you want to update the script code and deploy again, you can simply run this command again:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">capsule deploy --address ckt1qyq075y5ctzlgahu8pgsqxrqnglajgwa9zksmqdupd</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The new script will be automatically migrated which means destroy the old script cells and create new cells.
You will find  <code>new_occupied_capacity</code> is <code>0</code> because <code>capacity</code> is already covered by the old script cells.Please don’t forget the transaction fee you still need to pay it.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Deployment plan:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">---</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">migrated_capacity: 33629.0 (CKB)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">new_occupied_capacity: 0.0 (CKB)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">txs_fee_capacity: 0.0001 (CKB)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">total_occupied_capacity: 33629.0 (CKB)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">recipe:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  cells:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: my-sudt</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      index: 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      tx_hash: 0x10d508a0b44d3c1e02982f85a3e9b5d23d3961fddbf554d20abb4bf54f61950a</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      occupied_capacity: 33629.0 (CKB)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      data_hash: 0xaa3d472025e6afefdf3f65c5f9beefd206b4283b30551baef83cbb4762e6d397</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      type_id: ~</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  dep_groups: []</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Confirm deployment? (Yes/No)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="next-steps">Next Steps<a aria-hidden="true" class="hash-link" href="#next-steps" title="Direct link to heading">​</a></h2><p>This is the end of our journey into writing a SUDT script by Capsule. We have launched the <a href="https://www.nervos.org/grants/" target="_blank" rel="noopener noreferrer">Nervos Grants Program</a> and <a href="https://medium.com/nervosnetwork/introducing-cklabs-the-nervos-incubator-3e5a2c443c7c" target="_blank" rel="noopener noreferrer">CKLabs</a> to empower innovation and development and support the growth of a diverse and thriving ecosystem. We can&#x27;t wait to see what you build next!</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/develop/docs/develop/tools/capsule/intro"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« <!-- -->Introduction</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/develop/docs/develop/tools/capsule/capsule-dynamic-loading-tutorial"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Dynamic loading in Capsule<!-- --> »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#prepare-to-write-the-sudt-script" class="table-of-contents__link toc-highlight">Prepare to write the SUDT script</a><ul><li><a href="#run-a-dev-chain-and-ckb-cli" class="table-of-contents__link toc-highlight">Run a dev chain and ckb-cli</a></li><li><a href="#install-capsule" class="table-of-contents__link toc-highlight">Install Capsule</a></li><li><a href="#create-a-project" class="table-of-contents__link toc-highlight">Create a project</a></li><li><a href="#build-the-project" class="table-of-contents__link toc-highlight">Build the project</a></li></ul></li><li><a href="#write-a-sudt-script" class="table-of-contents__link toc-highlight">Write a SUDT script</a><ul><li><a href="#check-the-used-libraries" class="table-of-contents__link toc-highlight">Check the used libraries</a></li><li><a href="#load-script" class="table-of-contents__link toc-highlight">Load Script</a></li><li><a href="#check-inputs" class="table-of-contents__link toc-highlight">Check inputs</a></li><li><a href="#load-inputs--outputs-udt-amount" class="table-of-contents__link toc-highlight">Load inputs / outputs UDT amount</a></li><li><a href="#use-iterator-to-query-cells" class="table-of-contents__link toc-highlight">Use Iterator to query cells</a></li><li><a href="#build-the-project-1" class="table-of-contents__link toc-highlight">Build the project</a></li></ul></li><li><a href="#testing" class="table-of-contents__link toc-highlight">Testing</a><ul><li><a href="#check-the-default-tests" class="table-of-contents__link toc-highlight">Check the default tests</a></li><li><a href="#write-new-tests" class="table-of-contents__link toc-highlight">Write new tests</a></li></ul></li><li><a href="#deployment" class="table-of-contents__link toc-highlight">Deployment</a><ul><li><a href="#run-a-dev-chain-and-ckb-cli-1" class="table-of-contents__link toc-highlight">Run a dev chain and ckb-cli</a></li><li><a href="#deploy" class="table-of-contents__link toc-highlight">Deploy</a></li><li><a href="#migration" class="table-of-contents__link toc-highlight">Migration</a></li></ul></li><li><a href="#next-steps" class="table-of-contents__link toc-highlight">Next Steps</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Foundation</div><ul class="footer__items"><li class="footer__item"><a href="https://www.nervos.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">About Us</a></li></ul></div><div class="col footer__col"><div class="footer__title">Developer</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/nervosnetwork" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a href="https://github.com/nervosnetwork/rfcs/blob/master/rfcs/0002-ckb/0002-ckb.md" target="_blank" rel="noopener noreferrer" class="footer__link-item">Whitepaper</a></li><li class="footer__item"><a href="https://github.com/nervosnetwork/rfcs" target="_blank" rel="noopener noreferrer" class="footer__link-item">RFCs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://discord.gg/AqGTUE9" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://talk.nervos.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Forum</a></li><li class="footer__item"><a href="https://www.reddit.com/r/NervosNetwork/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Reddit</a></li><li class="footer__item"><a href="https://t.me/nervosnetwork" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/nervosnetwork" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li><li class="footer__item"><a href="https://medium.com/nervosnetwork" target="_blank" rel="noopener noreferrer" class="footer__link-item">Medium</a></li><li class="footer__item"><a href="https://www.youtube.com/channel/UCONuJGdMzUY0Y6jrPBOzH7A" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021  Nervos Foundation. All Rights Reserved.</div></div></div></footer></div>
<script src="/develop/assets/js/runtime~main.9a7d223e.js"></script>
<script src="/develop/assets/js/main.b81bb0ca.js"></script>
</body>
</html>